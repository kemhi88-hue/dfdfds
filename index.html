<script>
const ORIGINAL_CSV =
  'https://docs.google.com/spreadsheets/d/e/2PACX-1vSyIS6NTiGHKz7BR5e8PEshKhRJWJcUC9bR8Gp5_WuqfsEGOwRdaARGcR-CwV7Dn_gUYRxcZ12Yb20I/pub?output=csv';

const CSV_URL =
  'https://api.allorigins.win/raw?url=' +
  encodeURIComponent(ORIGINAL_CSV);

function parseCSVLine(line) {
  const regex = /(".*?"|[^",]+)(?=\s*,|\s*$)/g;
  const result = line.match(regex);
  return result ? result.map(v => v.replace(/^"|"$/g, '').trim()) : [];
}

function openLogin(email, password) {
  const url = `https://cloud.vsphone.com/login?email=${encodeURIComponent(email)}&pass=${encodeURIComponent(password)}`;
  window.open(url, '_blank');
}

fetch(CSV_URL)
  .then(res => {
    if (!res.ok) throw new Error('Failed to fetch CSV');
    return res.text();
  })
  .then(text => {
    text = text.replace(/\uFEFF/g, '').trim();
    const lines = text.split(/\r?\n/);
    const tbody = document.getElementById('tbody');
    tbody.innerHTML = '';

    if (lines.length < 2) {
      tbody.innerHTML = '<tr><td colspan="5" class="error">‚ö†Ô∏è Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>';
      return;
    }

    let accountCount = 0;

    for (let i = 1; i < lines.length; i++) {
      const cols = parseCSVLine(lines[i]);
      if (cols.length < 4) continue;

      const [platform, email, password, status] = cols;
      if (!email || !password) continue;

      accountCount++;
      const statusClass = /active|ho·∫°t/i.test(status)
        ? 'status-active' : 'status-inactive';

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><strong>${platform || 'VSPhone'}</strong></td>
        <td>${email}</td>
        <td class="password-cell">${'‚Ä¢'.repeat(password.length)}</td>
        <td class="${statusClass}">${status}</td>
        <td style="text-align:center">
          <button class="btn"
            onclick="openLogin('${email.replace(/'/g, "\\'")}','${password.replace(/'/g, "\\'")}')">
            üöÄ LOGIN
          </button>
        </td>
      `;
      tbody.appendChild(tr);
    }

    if (accountCount === 0) {
      tbody.innerHTML = '<tr><td colspan="5" class="loading">Kh√¥ng c√≥ t√†i kho·∫£n h·ª£p l·ªá</td></tr>';
    }
  })
  .catch(err => {
    console.error('CSV LOAD ERROR:', err);
    document.getElementById('tbody').innerHTML =
      '<tr><td colspan="5" class="error">‚ùå L·ªói t·∫£i d·ªØ li·ªáu</td></tr>';
  });
</script>
