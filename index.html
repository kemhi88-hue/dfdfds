// ==UserScript==
// @name         VSPhone Auto Login (GM Bridge – Stable)
// @namespace    vsphone-autologin-bridge
// @version      2.0.0
// @match        https://cloud.vsphone.com/*
// @run-at       document-end
// ==/UserScript==

(function () {
    'use strict';

    console.log('[AutoLogin] Script loaded');

    const STORAGE_KEY = 'VS_LOGIN_DATA';
    let creds = null;

    function loadCreds() {
        try {
            const raw = localStorage.getItem(STORAGE_KEY);
            if (!raw) return null;

            const data = JSON.parse(raw);
            if (!data.email || !data.password) return null;

            // Chỉ dùng trong 2 phút
            if (Date.now() - data.time > 120000) {
                localStorage.removeItem(STORAGE_KEY);
                return null;
            }

            return data;
        } catch {
            return null;
        }
    }

    function visible(el) {
        return el && el.offsetParent !== null;
    }

    // === FIX CHO REACT INPUT ===
    function reactFill(input, value) {
        const setter = Object.getOwnPropertyDescriptor(
            window.HTMLInputElement.prototype,
            'value'
        ).set;

        setter.call(input, value);
        input.dispatchEvent(new Event('input', { bubbles: true }));
        input.dispatchEvent(new Event('change', { bubbles: true }));
    }

    function findInputs() {
        const inputs = [...document.querySelectorAll('input')]
            .filter(i => visible(i));

        const pass = inputs.find(i => i.type === 'password');
        if (!pass) return {};

        const user =
            inputs.find(i => i.type === 'email') ||
            inputs.find(i => /email|user|login/i.test(i.name || '')) ||
            inputs.find(i => i !== pass);

        return { user, pass };
    }

    function findLoginButton(pass) {
        return (
            [...document.querySelectorAll('button,input[type=submit]')]
                .find(b =>
                    visible(b) &&
                    /(login|sign in|đăng nhập)/i.test(
                        b.innerText || b.value || ''
                    )
                ) ||
            pass?.form?.querySelector('button,input[type=submit]')
        );
    }

    function tryLogin() {
        const timer = setInterval(() => {
            if (!creds) return;

            const { user, pass } = findInputs();
            if (!user || !pass) return;

            const btn = findLoginButton(pass);
            if (!btn) return;

            clearInterval(timer);

            console.log('[AutoLogin] Filling form');

            reactFill(user, creds.email);
            reactFill(pass, creds.password);

            setTimeout(() => {
                console.log('[AutoLogin] Submit');
                btn.click();
                localStorage.removeItem(STORAGE_KEY);
            }, 600);

        }, 300);
    }

    // ===== START =====
    creds = loadCreds();
    if (creds) {
        console.log('[AutoLogin] Credentials loaded');
        tryLogin();
    }

})();
